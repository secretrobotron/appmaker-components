<element name="app-mozfest">
  <template>
    <style type="text/css">
      app-mozfest .session {
        margin-top: 5px;
        margin-bottom: 5px;
        padding: 5px;
        clear: both;
        border-bottom: 1px solid #ccc;
      }

      app-mozfest .title {
        color: #11B;
        cursor: pointer;
      }

      app-mozfest .time {
        text-align: right;
        font-size: .8em;
        font-style: italic;
        display: inline;
        float: right;
      }

      app-mozfest .location {
        display: inline;
        float: left;
      }

      app-mozfest .description {
        display: none;
      }

      app-mozfest .description.on {
        display: block;
      }

      app-mozfest .meta-container {
        position: relative;
        width: 100%;
        height: 1.2em;
        margin-top: 5px;
        margin-bottom: 2px;
      }
    </style>
  </template>
  <friends>app-button</friends>
  <thumbnail>
    <span style="color: #fff; text-align: center;">Mozfest 2013</span>
  </thumbnail>
  <description>
    Shows session details for MozFest 2013.
  </description>
  <script type="text/ceci">
    Ceci(this, {
      init: function (params) {
        var gids = [23, 24];

        var gid = 23;
        var callbackFunction = '_appmakerMozfestCallback' + (Math.round(Math.random() * 1000));
        var that = this;

        function loadContent (gid) {

        }

        window[callbackFunction] = function (data) {
          delete window[callbackFunction];
          var tmpDiv = document.createElement('div');
          tmpDiv.innerHTML = data;
          var entries = tmpDiv.querySelectorAll('entry');
          var sessions = [];
          Array.prototype.forEach.call(entries, function (entry) {
            var entryData = entry.querySelector('category');
            var cell = entryData.querySelector('title').innerHTML.match(/([A-Z]+)([0-9]+)/);
            var col = cell[1];
            var row = Number(cell[2]) - 1;

            if (row === 0) return;

            var session = sessions[row] || {};

            var map = {
              A: 'start',
              B: 'end',
              C: 'location',
              D: 'title',
              E: 'description',
              H: 'link'
            };

            if (map[col]) {
              session[map[col]] = entryData.querySelector('content').innerHTML;
            }

            sessions[row] = session;
          });

          sessions = sessions.sort(function (a, b) {
            return (a.start < b.start) ? -1 : (a.start > b.start ? 1 : 0);
          });

          var iframe;

          sessions.forEach(function (session) {
            var sessionDiv = document.createElement('div');
            var titleDiv = document.createElement('div');
            var timeDiv = document.createElement('div');
            var descriptionDiv = document.createElement('div');
            var locationDiv = document.createElement('div');
            var metaContainer = document.createElement('div');
            metaContainer.classList.add('meta-container');
            sessionDiv.classList.add('session');
            locationDiv.classList.add('location');
            descriptionDiv.classList.add('description');
            timeDiv.classList.add('time');
            titleDiv.classList.add('title');
            titleDiv.innerHTML = session.title;
            descriptionDiv.innerHTML = session.description;
            timeDiv.innerHTML = session.start + ' - ' + session.end;
            locationDiv.innerHTML = session.location;
            metaContainer.appendChild(locationDiv);
            metaContainer.appendChild(timeDiv);
            sessionDiv.appendChild(titleDiv);
            sessionDiv.appendChild(descriptionDiv);
            sessionDiv.appendChild(metaContainer);
            that.appendChild(sessionDiv);

            titleDiv.onclick = function (e) {
              descriptionDiv.classList.toggle('on');
            };
          });
        };

        var scriptTag = document.createElement('script');
        scriptTag.src = 'http://spreadsheets.google.com/feeds/cells/0Ajsn8X28XnbZdFlxaEExNkREa1VmWndSdzZjeHRBOXc/' + gid + '/public/basic?callback=' + callbackFunction;
        document.head.appendChild(scriptTag);
      },
      editable: {
        // buttonLabel: {
        //   type: "text",
        //   description: "A text for your label to show up in your app",
        //   postset: function(v) {
        //     this.setLabel(v);
        //   }
        // },
        // textColor: {
        //   type: "text",
        //   description: "The color of the button label",
        //   postset: function(v) {
        //     this.setTextColor(v);
        //   }
        // },
        // buttonColor: {
        //   type: "text",
        //   description: "The color of your button",
        //   postset: function(v) {
        //     this.setButtonColor(v);
        //   }
        // }
      },
      // setLabel: function (val) {
      //   this.querySelector('button').innerHTML = val;
      // },
      // setButtonColor: function (val) {
      //   this.querySelector('button').style.backgroundColor = val;
      // },
      // setTextColor: function (val) {
      //   this.querySelector('button').style.color = val;
      // },
      // broadcasts: ['click', 'mouseDown', 'mouseUp']
    });
  </script>
</element>
